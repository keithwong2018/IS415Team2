---
title: "wrangling"
author: "Veronica Lee Xuan Hui"
date: "10/23/2020"
output: 
  html_document: 
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Packages
```{r}
packages = c('rgdal', 'sf', 'tmap', 'tidyverse', 'sp', 'rgeos','maptools', 'raster', 'spatstat', 'spdep', 'OpenStreetMap', 'tmaptools', 'spatialEco', 'SpatialAcc', 'ggstatsplot', 'SpatialPosition')
for (p in packages){
  if (!require(p, character.only = T)){
    install.packages(p)
  }
  library(p, character.only = T)
}
```

## Population Data 
```{r}
popdata <- read_csv('data/aspatial/planning-area-subzone-age-group-sex-and-type-of-dwelling-june-2011-2019.csv')
```

```{r}
popdata2019 <- popdata %>%
  filter(year == 2019) %>%
  # filter(age_group == "65_to_69" | age_group == "70_to_74" | age_group == '75_to_79' | age_group == '80_to_84' | age_group == '85_to_89' | age_group == '90_and_over') %>%
  group_by(planning_area, subzone, age_group) %>%
  summarise(count = sum(resident_count)) %>%
  ungroup() %>%
  spread(age_group, count) %>%
  mutate(elderly_count = `65_to_69` + `70_to_74` + `75_to_79` + `80_to_84` + `85_to_89` + `90_and_over`) %>%
  mutate(total_count = rowSums(.[3:21])) %>%
  dplyr::select(planning_area, subzone, elderly_count, total_count)
popdata2019 <- mutate_at(popdata2019, .vars = c("subzone", "planning_area"), .funs=toupper)
```
```{r}
glimpse(popdata2019)
```


## MP_14 Subzone Data
```{r}
mpsz_sf <- st_read(dsn='data/geospatial', layer='MP14_SUBZONE_WEB_PL')
mpsz_sf <- mpsz_sf %>%
  dplyr::select(SUBZONE_N, PLN_AREA_N, REGION_N, X_ADDR, Y_ADDR, SHAPE_Leng, SHAPE_Area, geometry)
mpsz_sf <- st_transform(mpsz_sf, 3414)
mpsz_sp <- as_Spatial(mpsz_sf)
```



## HDB Data File
```{r}
hdb <- read_csv('data/aspatial/hdb_data.csv')
hdb <- hdb %>% 
  mutate(total_count=rowSums(.[2:11])) %>%
  dplyr::select(Postcode, X, Y, Latitude, Longitude, total_count)
hdb$Postcode <- as.character(hdb$Postcode)
hdb_sf <- st_as_sf(hdb, coords=c('X', 'Y'), crs='EPSG:3414')
```




## Eldercare 
```{r}
eldercare_sf <- st_read(dsn='data/geospatial', layer='ELDERCARE')
eldercare_sf <- eldercare_sf %>%
  dplyr::select(NAME, ADDRESSPOS, ADDRESSSTR, X_ADDR, Y_ADDR, geometry) %>%
  mutate(label = "Eldercare centres") %>%
  mutate(capacity = 1)
eldercare_sf <- st_transform(eldercare_sf, 3414)
eldercare_sf <- st_join(mpsz_sf, eldercare_sf, join=st_intersects) %>%
  dplyr::select(SUBZONE_N, PLN_AREA_N, REGION_N, NAME, ADDRESSPOS, ADDRESSSTR, capacity, label, geometry)
eldercare_sp <- as_Spatial(eldercare_sf)

```


## Silver Infocomm
```{r}
infocomm_sf <- st_read(dsn='data/geospatial', layer='SILVERINFOCOMM')
infocomm_sf <- infocomm_sf %>%
  dplyr::select(NAME, ADDRESSBUI, ADDRESSPOS, X_ADDR, Y_ADDR, geometry) %>%
  mutate(label = "Silver Infocomm Junc") %>%
  mutate(capacity = 1)
infocomm_sf <- st_transform(infocomm_sf, 3414)
infocomm_sf <- st_join(mpsz_sf, infocomm_sf, join=st_intersects) %>%
  dplyr::select(SUBZONE_N, PLN_AREA_N, REGION_N, NAME, ADDRESSBUI, ADDRESSPOS, capacity, label, geometry)
infocomm_sp <- as_Spatial(infocomm_sf)

```


## CHAS Clinics
```{r}
chas_sf <- st_read(dsn='data/geospatial/chas-clinics-kml.kml')
chas_sf <- chas_sf %>%
  mutate(label = "Chas Clinics") %>%
  mutate(capacity = 1)
chas_sf <- st_transform(chas_sf, 3414)
chas_sf <- st_join(mpsz_sf, chas_sf, join=st_intersects) %>%
  dplyr::select(SUBZONE_N, PLN_AREA_N, REGION_N, Name, Description, capacity, label, geometry)
chas_sp <- as_Spatial(chas_sf)

```

## Coastal outline
```{r}
sg <- readOGR(dsn = "data/geospatial", layer="CostalOutline")
sg_osm <- read_osm(mpsz_sp, ext=1.3)
```

# Adding additional information into mpsz_sf
```{r}
mpsz_sf <- left_join(mpsz_sf, popdata2019, by=c('PLN_AREA_N' = 'planning_area', 'SUBZONE_N' = 'subzone'))
glimpse(mpsz_sf)
```

```{r}
mpsz_sf <- mpsz_sf %>%
  dplyr::select(SUBZONE_N, PLN_AREA_N, REGION_N, elderly_count, total_count, geometry) %>%
  mutate(elderly_density = elderly_count / total_count) %>%
  mutate_if(is.numeric, ~replace(., is.nan(.), 0))
```

```{r}
mpsz_demand <- mpsz_sf
mpsz_demand$eldercare <- lengths(st_intersects(mpsz_sf, eldercare_sf))
mpsz_demand$chas_clinic <- lengths(st_intersects(mpsz_sf, chas_sf))
mpsz_demand$silver_infocomm <- lengths(st_intersects(mpsz_sf, infocomm_sf))
```

```{r}
glimpse(mpsz_demand)
```


# Estimating the elderly count in residential polygon (INTERPOLATION)
need to join with mpsz_sf, interpolate to find total elderly count for each residential point
```{r}
hdb_sf <- st_join(mpsz_sf, hdb_sf, join=st_intersects) %>%
  select(SUBZONE_N, PLN_AREA_N, REGION_N, elderly_density, Postcode, total_count.y, geometry) %>%
  rename(resident_count = total_count.y) %>%
  mutate(elderly_count = resident_count * elderly_density) %>%
  mutate_if(is.numeric, ~replace(., is.na(.), 0))
glimpse(hdb_sf)
```


# Create new dataframe to find centroids of the residential polygon (copy from previous section)
```{r}
sum(is.na(hdb_sf))
```








## Visualisations
```{r}
tm_shape(sg_osm)+ 
  tm_layout(legend.outside = TRUE)+
  tm_rgb()+
tm_shape(sg)+
  tm_borders(alpha=0.5, col = "black", lwd = 1)+
tm_shape(chas_sp)+
  tm_dots(col = "label",
          title="",
          alpha=0.7,
          size = 0.1,
          border.col = "black",
          border.lwd = 5,
          palette=c("red"))+
  tm_shape(eldercare_sp)+
  tm_dots(col = "label",
          title="",
          alpha=0.7,
          size = 0.1,
          border.col = "black",
          border.lwd = 5,
          palette=c("green"))+
  tm_shape(infocomm_sp)+
  tm_dots(col = "label",
          title="",
          alpha=0.7,
          size = 0.1,
          border.col = "black",
          border.lwd = 5,
          palette=c("blue")) +
    tm_layout("Facility Type",
            title.size = 1,
            legend.text.size = 1,
            legend.title.size = 1)
```

```{r}
plot(mpsz_sp, border="darkgrey")+
plot(chas_spatialpoint, add=TRUE)
```


```{r}
sg_owin <- as(mpsz_sp, "owin")
plot(sg_owin)
```




